# GitLab CI/CD Pipeline for gitlab-cicd-dashboard
# Runs tests, builds the project, and deploys to Cloudflare Pages

image: node:20

# Prevent duplicate pipelines: MR pipelines take priority over branch pipelines
workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS == null
    - if: $CI_COMMIT_TAG

stages:
  - .pre
  - test
  - build
  - deploy
  - post-deploy
  - release

# Dedicated install job - runs once per pipeline
install:
  stage: .pre
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  script:
    - npm ci
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# Run unit tests
test:
  stage: test
  needs: [install]
  script:
    - npm test
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# Run linting
lint:
  stage: test
  needs: [install]
  script:
    - npm run lint
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# Build the project
build:
  stage: build
  needs: [install]
  script:
    - npm run build
    - echo "Build output:"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# Deploy to Cloudflare Pages
# - main branch -> production (gitlab-cicd-dashboard.pages.dev)
# - other branches -> preview ({branch-slug}.gitlab-cicd-dashboard.pages.dev)
# Note: Branch slug is truncated to 25 chars to avoid Cloudflare's unpredictable truncation
deploy:
  stage: deploy
  needs:
    - job: build
      artifacts: true
  variables:
    CLOUDFLARE_ACCOUNT_ID: $CLOUDFLARE_ACCOUNT_ID
    CLOUDFLARE_API_KEY: $CLOUDFLARE_API_TOKEN
  script:
    - npm install -g wrangler
    # Create a short branch slug (max 25 chars) to avoid Cloudflare truncation
    # Also strip trailing hyphens since Cloudflare normalizes them away
    # Use CI_COMMIT_REF_NAME (works for both branch and MR pipelines)
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        BRANCH_SLUG="main"
      else
        BRANCH_SLUG=$(echo "${CI_COMMIT_REF_SLUG}" | cut -c1-25 | sed 's/-*$//')
      fi
      echo "Deploying with branch slug: $BRANCH_SLUG"
      echo "BRANCH_SLUG=$BRANCH_SLUG" >> deploy.env
      CLOUDFLARE_API_KEY=$CLOUDFLARE_API_TOKEN CLOUDFLARE_EMAIL=$CLOUDFLARE_EMAIL wrangler pages deploy dist --project-name=gitlab-cicd-dashboard --branch=$BRANCH_SLUG
  artifacts:
    reports:
      dotenv: deploy.env
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID
  environment:
    name: $CI_COMMIT_REF_SLUG
    url: https://${CI_COMMIT_REF_SLUG}.gitlab-cicd-dashboard.pages.dev

# Post-deployment verification (all branches)
post-deploy-test:
  stage: post-deploy
  needs:
    - job: install
      artifacts: true
    - job: deploy
      artifacts: true
  script:
    # Use production URL for main, branch-specific URL for others
    # BRANCH_SLUG is passed from deploy job via dotenv artifact
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        DEPLOY_URL="https://gitlab-cicd-dashboard.pages.dev"
      else
        DEPLOY_URL="https://${BRANCH_SLUG}.gitlab-cicd-dashboard.pages.dev"
      fi
      echo "Testing deployment at: $DEPLOY_URL"
      npm run test:deployment "$DEPLOY_URL"
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# E2E tests with Playwright (all branches)
# Note: Uses Playwright image but inherits node_modules from install job.
# If native module issues occur, may need to run npm ci here instead.
e2e-test:
  stage: post-deploy
  image: mcr.microsoft.com/playwright:v1.58.0-jammy
  needs:
    - job: install
      artifacts: true
    - job: deploy
      artifacts: true
  script:
    # BRANCH_SLUG is passed from deploy job via dotenv artifact
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        export BASE_URL="https://gitlab-cicd-dashboard.pages.dev"
      else
        export BASE_URL="https://${BRANCH_SLUG}.gitlab-cicd-dashboard.pages.dev"
      fi
      echo "Running E2E tests against: $BASE_URL"
      npx playwright test --reporter=list
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID
  allow_failure: true  # Don't block MR if E2E tests fail initially
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week

# Semantic release - creates tags and releases on main branch
# Requires Node 22+ (semantic-release v25 dropped Node 20 support)
# Uses RELEASE_TOKEN (project PAT) for git push permissions
release:
  stage: release
  image: node:22
  variables:
    GITLAB_TOKEN: $RELEASE_TOKEN
    GIT_AUTHOR_NAME: "craw-cube"
    GIT_AUTHOR_EMAIL: "craw-cube@users.noreply.gitlab.com"
    GIT_COMMITTER_NAME: "craw-cube"
    GIT_COMMITTER_EMAIL: "craw-cube@users.noreply.gitlab.com"
  before_script:
    # Configure git to use the token for pushing
    - git config --global user.email "$GIT_COMMITTER_EMAIL"
    - git config --global user.name "$GIT_COMMITTER_NAME"
    - git remote set-url origin "https://oauth2:${RELEASE_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
  script:
    - npm ci
    - npx semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs:
    - job: install
      artifacts: true
    - job: test
    - job: lint
    - job: build
    - job: e2e-test
      optional: true
