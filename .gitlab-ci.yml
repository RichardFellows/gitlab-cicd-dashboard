# GitLab CI/CD Pipeline for gitlab-cicd-dashboard
# Runs tests, builds the project, and deploys to GitLab Pages

image: node:20

# Prevent duplicate pipelines: MR pipelines take priority over branch pipelines
# Auto-cancel: if MR pipeline starts, cancel any running branch pipeline for same commit
workflow:
  auto_cancel:
    on_new_commit: interruptible
    on_job_failure: none
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS == null
    - if: $CI_COMMIT_TAG

# Default settings for all jobs
default:
  interruptible: true

stages:
  - .pre
  - test
  - build
  - deploy
  - post-deploy
  - release

# Dedicated install job - runs once per pipeline
install:
  stage: .pre
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  script:
    - npm ci
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# Run unit tests (with coverage for SonarCloud)
test:
  stage: test
  needs: [install]
  script:
    - npm run test:coverage
  artifacts:
    paths:
      - coverage/
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# Run linting
lint:
  stage: test
  needs: [install]
  script:
    - npm run lint
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# SonarCloud analysis
# Requires SONAR_TOKEN CI/CD variable (group or project level)
# Setup: https://sonarcloud.io â†’ create org "cube-craw", import project, generate token
sonarcloud:
  stage: test
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  needs:
    - job: test
      artifacts: true
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"  # Full clone needed for accurate blame/history
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - |
      sonar-scanner \
        -Dsonar.host.url=https://sonarcloud.io \
        -Dsonar.token=${SONAR_TOKEN} \
        -Dsonar.qualitygate.wait=true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_IID
  allow_failure: true  # Remove once SONAR_TOKEN is configured

# Build the project
build:
  stage: build
  needs: [install]
  script:
    - npm run build
    - echo "Build output:"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# Deploy to GitLab Pages
# - main branch -> production (cube-craw.gitlab.io/gitlab-cicd-dashboard)
# - other branches -> preview (cube-craw.gitlab.io/gitlab-cicd-dashboard/$CI_COMMIT_REF_SLUG)
# Uses GitLab's multiple deployments feature (16.7+) for branch previews
pages:
  stage: deploy
  needs:
    - job: build
      artifacts: true
  script:
    - mv dist/ public/
  artifacts:
    paths:
      - public/
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID
  environment:
    name: $CI_COMMIT_REF_SLUG
    url: $CI_PAGES_URL

# Post-deployment verification (all branches)
post-deploy-test:
  stage: post-deploy
  needs:
    - job: install
      artifacts: true
    - job: pages
      artifacts: false
  script:
    - |
      DEPLOY_URL="${CI_PAGES_URL}"
      echo "Testing deployment at: $DEPLOY_URL"
      npm run test:deployment "$DEPLOY_URL"
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# E2E tests with Playwright - runs nightly on main only (scheduled)
# Full test suite against production deployment
e2e-test:
  stage: post-deploy
  image: mcr.microsoft.com/playwright:v1.58.0-jammy
  needs:
    - job: install
      artifacts: true
  script:
    - export BASE_URL=https://cube-craw.gitlab.io/gitlab-cicd-dashboard
    - echo "Running full E2E suite"
    - npx playwright test --reporter=list
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_BRANCH == "main"'
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week

# Semantic release - creates tags and releases on main branch
# Requires Node 22+ (semantic-release v25 dropped Node 20 support)
# Token needs: Maintainer role, api + write_repository scopes
release:
  stage: release
  image: node:22
  variables:
    GL_TOKEN: $RELEASE_TOKEN
    GITLAB_TOKEN: $RELEASE_TOKEN
    GIT_AUTHOR_NAME: "craw-cube"
    GIT_AUTHOR_EMAIL: "craw-cube@users.noreply.gitlab.com"
    GIT_COMMITTER_NAME: "craw-cube"
    GIT_COMMITTER_EMAIL: "craw-cube@users.noreply.gitlab.com"
    GIT_CREDENTIALS: oauth2:$RELEASE_TOKEN
  before_script:
    - git config --global user.email "$GIT_COMMITTER_EMAIL"
    - git config --global user.name "$GIT_COMMITTER_NAME"
    # Configure git to use token for HTTPS
    - git config --global credential.helper store
    - echo "https://oauth2:${RELEASE_TOKEN}@gitlab.com" > ~/.git-credentials
    - git remote set-url origin "https://oauth2:${RELEASE_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
  script:
    - npm ci
    - npx semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs:
    - job: install
      artifacts: true
    - job: test
    - job: lint
    - job: build
    - job: post-deploy-test
