# GitLab CI/CD Pipeline for gitlab-cicd-dashboard
# Runs tests, builds the project, and deploys to GitLab Pages

image: node:20

# Cache node_modules between jobs
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

stages:
  - test
  - build
  - deploy
  - post-deploy

# Install dependencies (shared script)
.install_dependencies: &install_dependencies
  - npm ci

# Run unit tests
test:
  stage: test
  script:
    - *install_dependencies
    - npm test
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Run linting
lint:
  stage: test
  script:
    - *install_dependencies
    - npm run lint
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build the project
build:
  stage: build
  script:
    - *install_dependencies
    - npm run build
    - echo "Build output:"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Deploy review app for merge requests
review:
  stage: deploy
  script:
    - rm -rf public
    - mv dist public
    - echo "Deploying review app for MR !${CI_MERGE_REQUEST_IID}..."
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: 1 week
  dependencies:
    - build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  environment:
    name: review/$CI_MERGE_REQUEST_IID
    url: https://gitlab.com/richard2/gitlab-cicd-dashboard/-/jobs/$CI_JOB_ID/artifacts/public/index.html
    on_stop: review_stop
    auto_stop_in: 1 week

# Stop review app when MR is merged/closed
review_stop:
  stage: deploy
  script:
    - echo "Stopping review app for MR !${CI_MERGE_REQUEST_IID}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
  environment:
    name: review/$CI_MERGE_REQUEST_IID
    action: stop

# Deploy to GitLab Pages (only on main branch)
# GitLab Pages requires the job to be named 'pages' and artifacts in 'public/'
pages:
  stage: deploy
  script:
    - rm -rf public
    - mv dist public
    - echo "Deploying to GitLab Pages..."
    - ls -la public/
  artifacts:
    paths:
      - public
  dependencies:
    - build
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production
    url: $CI_PAGES_URL

# Post-deployment verification
post-deploy-test:
  stage: post-deploy
  script:
    - *install_dependencies
    - npm run test:deployment $CI_PAGES_URL
  dependencies: []
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs:
    - job: pages
      artifacts: false
