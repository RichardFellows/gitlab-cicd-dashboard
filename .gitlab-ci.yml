# GitLab CI/CD Pipeline for gitlab-cicd-dashboard
# Runs tests, builds the project, and deploys to Cloudflare Pages

image: node:20

# Cache node_modules between jobs
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

stages:
  - test
  - build
  - deploy
  - post-deploy

# Install dependencies (shared script)
.install_dependencies: &install_dependencies
  - npm ci

# Run unit tests
test:
  stage: test
  script:
    - *install_dependencies
    - npm test
  rules:
    - if: $CI_COMMIT_BRANCH

# Run linting
lint:
  stage: test
  script:
    - *install_dependencies
    - npm run lint
  rules:
    - if: $CI_COMMIT_BRANCH

# Build the project
build:
  stage: build
  script:
    - *install_dependencies
    - npm run build
    - echo "Build output:"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH

# Deploy to Cloudflare Pages
# - main branch -> production (gitlab-cicd-dashboard.pages.dev)
# - other branches -> preview ({branch}.gitlab-cicd-dashboard.pages.dev)
deploy:
  stage: deploy
  variables:
    CLOUDFLARE_ACCOUNT_ID: $CLOUDFLARE_ACCOUNT_ID
    CLOUDFLARE_API_KEY: $CLOUDFLARE_API_TOKEN
  script:
    - npm install -g wrangler
    - echo "Deploying branch ${CI_COMMIT_BRANCH} to Cloudflare Pages..."
    - CLOUDFLARE_API_KEY=$CLOUDFLARE_API_TOKEN CLOUDFLARE_EMAIL=$CLOUDFLARE_EMAIL wrangler pages deploy dist --project-name=gitlab-cicd-dashboard --branch=${CI_COMMIT_BRANCH}
  dependencies:
    - build
  rules:
    - if: $CI_COMMIT_BRANCH
  environment:
    name: $CI_COMMIT_BRANCH
    url: https://${CI_COMMIT_REF_SLUG}.gitlab-cicd-dashboard.pages.dev

# Post-deployment verification (all branches)
post-deploy-test:
  stage: post-deploy
  script:
    - *install_dependencies
    # Use production URL for main, branch-specific URL for others
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        DEPLOY_URL="https://gitlab-cicd-dashboard.pages.dev"
      else
        # Cloudflare truncates long branch names, so we use the slug
        DEPLOY_URL="https://${CI_COMMIT_REF_SLUG}.gitlab-cicd-dashboard.pages.dev"
      fi
      echo "Testing deployment at: $DEPLOY_URL"
      npm run test:deployment "$DEPLOY_URL"
  dependencies: []
  rules:
    - if: $CI_COMMIT_BRANCH
  needs:
    - job: deploy
      artifacts: false

# E2E tests with Playwright (all branches)
e2e-test:
  stage: post-deploy
  image: mcr.microsoft.com/playwright:v1.40.0-jammy
  script:
    - npm ci
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        export BASE_URL="https://gitlab-cicd-dashboard.pages.dev"
      else
        export BASE_URL="https://${CI_COMMIT_REF_SLUG}.gitlab-cicd-dashboard.pages.dev"
      fi
      echo "Running E2E tests against: $BASE_URL"
      npx playwright test --reporter=list
  dependencies: []
  rules:
    - if: $CI_COMMIT_BRANCH
  needs:
    - job: deploy
      artifacts: false
  allow_failure: true  # Don't block MR if E2E tests fail initially
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week
